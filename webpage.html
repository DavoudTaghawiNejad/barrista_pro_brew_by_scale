<!DOCTYPE html>
<html lang="en">
<head>
    <title>Barrista Uber - by Davoud Taghawi-Nejad</title>
    <link href="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.css" rel="stylesheet">
    <script src="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .container { max-width: 800px; margin: auto; padding: 20px; }
        .controls { margin: 20px 0; }
        input { width: 100px; text-align: center; }
        canvas { max-width: 100%; }
        /* Hide number input spin buttons (Chrome, Safari, Edge) */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
        }
        /* Hide number input spin buttons (Firefox) */
        input[type=number] {
        -moz-appearance: textfield;
        }
    </style>
</head>
<body>
    <div class="mdc-snackbar">
        <div class="mdc-snackbar__surface">
            <div class="mdc-snackbar__label" role="status" aria-live="polite"></div>
            <div class="mdc-snackbar__actions">
                <button type="button" class="mdc-button mdc-snackbar__action">
                    <div class="mdc-button__ripple"></div>
                    <span class="mdc-button__label">Dismiss</span>
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Barrista Uber - by Davoud Taghawi-Nejad</h1>
        <canvas id="lineChart" width="400" height="200"></canvas>
        <div class="controls">
            <h3>Adjust Values</h3>
            <label>Extraction (grams):</label>
            <button class="mdc-button mdc-button--raised" id="decrease">-</button>
            <label class="mdc-text-field mdc-text-field--outlined" style="width: 100px;">
                <input type="number" id="extraction" class="mdc-text-field__input" min="0" max="100" value="{{extraction}}" step="1">
                <span class="mdc-notched-outline">
                  <span class="mdc-notched-outline__leading"></span>
                  <span class="mdc-notched-outline__notch">
                    <span class="mdc-floating-label">Grams</span>
                  </span>
                  <span class="mdc-notched-outline__trailing"></span>
                </span>
              </label>
            <button class="mdc-button mdc-button--raised" id="increase">+</button>
            <br><br>
            <button class="mdc-button mdc-button--filled" onclick="updateValues()">Update</button>
            <button class="mdc-button mdc-button--filled" onclick="makeCoffee()">Make Coffee</button>
        </div>
    </div>

    <script>
        let lineChart;
        let pollInterval;
        let snackbar;

        async function loadData() {
            try {
                const response = await fetch('/get_chart_data');
                if (!response.ok) throw new Error('Network response was not ok');
                const chartData = await response.json();
                lineChart.data.datasets[0].data = chartData;
                lineChart.update({ duration: 0 });
            } catch (error) {
                console.error("Error loading data:", error);
                snackbar.labelText = 'Failed to load data. Please try again.';
                snackbar.open();
            }
        }

        async function updateValues() {
            const extraction = document.getElementById('extraction').value;
            const response = await fetch('/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ extraction })
            });
            if (response.ok) {
                snackbar.labelText = 'Values updated!';
                snackbar.open();
                loadData();
            } else {
                snackbar.labelText = 'Update failed. Please try again.';
                snackbar.open();
            }
        }

        async function makeCoffee() {
            const extraction = document.getElementById('extraction').value;
            const response = await fetch('/make_coffee', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ extraction })
            });
            if (response.ok) {
                snackbar.labelText = 'Coffee making started!';
                snackbar.open();
            } else {
                snackbar.labelText = 'Coffee making failed. Please try again.';
                snackbar.open();
            }
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(loadData, 10);
        }

        window.onload = function () {
            // Initialize MDC buttons
            const buttons = document.querySelectorAll('.mdc-button');
            buttons.forEach(button => mdc.ripple.MDCRipple.attachTo(button));
            mdc.textField.MDCTextField.attachTo(document.querySelector('.mdc-text-field'));

            // Initialize snackbar once
            snackbar = mdc.snackbar.MDCSnackbar.attachTo(document.querySelector('.mdc-snackbar'));

            // Initialize chart
            const ctx = document.getElementById('lineChart').getContext('2d');
            lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 6001 }, (_, i) => i),
                    datasets: [{
                        label: 'Weight (grams)',
                        data: [],
                        borderColor: 'blue',
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    animation: { duration: 0 },
                    transitions: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time (seconds)' },
                            ticks: {
                                callback: function (value, index) {
                                    if (index % 100 === 0 && index <= 6000) {
                                        return (index / 100);
                                    }
                                    return null;
                                }
                            }
                        },
                        y: {
                            title: { display: true, text: 'Weight (grams)' },
                            min: 0,
                            max: 60
                        }
                    }
                }
            });

            loadData();
            startPolling();
        };

        document.getElementById('decrease').addEventListener('click', function () {
            const input = document.getElementById('extraction');
            let value = parseInt(input.value) || 0;
            if (value > 0) input.value = value - 1;
        });

        document.getElementById('increase').addEventListener('click', function () {
            const input = document.getElementById('extraction');
            let value = parseInt(input.value) || 0;
            if (value < 100) input.value = value + 1;
        });
    </script>
</body>
</html>
